<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ«ãƒ¼ãƒ </title>

    <style>
        .message-received {
            padding: 5px;
            margin: 5px;
            border-radius: 10px;
        }
        .text-message {
            background-color: #f2f2f2;
            display: inline-block;
        }
        .image-message img {
            max-width: 200px;
            border-radius: 10px;
            display: inline-block;
        }

          html {
            font-size: 100%;
            margin: 0;
            padding: 0;
          }
    
          body {
            font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", YuGothic, "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Yu Gothic", sans-serif;
            min-height: 100vh;
            line-height: 1.5;
            margin: 0;
            justify-content: center;
            align-items: center;
            height: 100vh;
          }

          h3 {
            text-align: center;
          }
    
          header {
            border-bottom: 3px solid #00CCFF;
            padding: 0px 0;
            text-align: center;
            color: #00CCFF;
          }
    
          header a {
            text-decoration: none;
            color: inherit;
            display: block;
            padding: 2px 0;
          }
    
          header a h1 {
            font-size: 36px;
            font-weight: bold;
            margin: 0;
          }
    
          header a p {
            font-size: 9px;
            margin: 0;
          }
    
          img, picture {
            max-width: 100%;
            display: block;
          }
    
          ul[role='list'], ol[role='list'] {
            list-style: none;
          }
    
          input, button, textarea, select {
            font: inherit;
          }

          #now-loading{
            display: none; 
            text-align: center; 
            color: gray;
          }

          #button-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
         }
          
         #chat-message-submit, #chat-image-submit {
            background-color: #50df248c;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
         }

         #chat-message-submit:hover, #chat-image-submit:hover {
            background-color: #68d047;
         }


          .chat-log {
            display: flex;
            flex-direction: column;
            padding: 10px;
            width: 80%;
            max-width: 600px;
            height: 400px;
            overflow-y: scroll;
            background-color: #d8d8d87d;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
          }

          .message-container {
              display: flex;
              margin: 10px 0;
          }

          .message-received {
              padding: 10px;
              border-radius: 15px;
              max-width: 60%;
              word-wrap: break-word;
              box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
          }

          .message-received.self {
              background-color: #d1f4ff;
              align-self: flex-start;
          }

          .message-received.other {
              background-color: #f2f2f2;
              align-self: flex-end;
          }

          .image-message img {
              max-width: 100px;
              max-height: 100px;
              border-radius: 10px;
          }

          @media screen and (max-width: 600px) {
              .message-received {
                  max-width: 80%;
              }
          }

    </style>

</head>

<header>
    <a href="{% url 'root' %}">
      <h1>Schapy</h1>
    </a>  
</header>

<body>
    <div id="chat-log"></div><br>
    <div id="now-loading">Now Loading...</div><br>

    <div id="button-container">
        <input id="chat-message-input" type="text" size="50">
        <input id="chat-message-submit" type="button" value="é€ä¿¡" aria-label="ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡">
    </div><br>
    <div id="button-container">
        <input id="chat-image-input" type="file" accept="image/*">
        <input id="chat-image-submit" type="button" value="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" aria-label="ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
    </div>
    
    <p>èª¹è¬—ä¸­å‚·çš„ãƒ†ã‚­ã‚¹ãƒˆä¾‹ï¼š</p>
    <ul>
        <li>ãŠå‰å«Œã„ã€‚</li>
        <li>ã†ã–ã„</li>
        <li>ã‚´ãƒŸ</li>
        <li>ãŠå‰ã€ã†ã‚ã†ã‚ã™ã‚‹ãªã€‚</li>
    </ul>
    <h4>ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹éš›ã¯å€‹äººåãªã©ã¯æŠ•ç¨¿ã—ãªã„ã§ãã ã•ã„ã€‚</h4>

    {{ room_name|json_script:"room-name" }}
    
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        let count = 0;
    
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const chatSocket = new WebSocket(
            protocol
            + window.location.host
            + '/ws/app01/chat/'
            + roomName
            + '/'
        );
    
        // NowLoadingã®è¡¨ç¤º
        function printLoading() {
            document.getElementById('now-loading').style.display = 'block';
        }

        // NowLoadingã®éè¡¨ç¤º
        function notLoading() {
            document.getElementById('now-loading').style.display = 'none';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹å‡¦ç†
        chatSocket.onmessage = function(e) {
            notLoading();

            const data = JSON.parse(e.data);

            const sender = data.sender || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å';  // é€ä¿¡è€…åã‚’å–å¾—
            // const userMind = data.user_mind || false;

            // if (userMind) {
            //     printPopup(data.message);
            // }

            if (data.message.includes('ãŒç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ: ')) {
                // ç”»åƒãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                const obj = data.message.split('ãŒç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ: ')[1]; 
                if (obj.includes('ğŸ˜Š')) {
                    // çµµæ–‡å­—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                    addTextMessage(sender, obj, 'other');
                } else {
                    // ç”»åƒURLãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                    addImageMessage(sender, obj, 'other');
                }
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
                addTextMessage(sender, data.message, 'other');
            }
        };

        // WebSocketåˆ‡æ–­æ™‚ã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã«è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
        document.querySelector('#chat-message-input').focus();

        // Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) { 
                document.querySelector('#chat-message-submit').click(); 
            }
        };

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-message-submit').onclick = function(e) {
            const msgInputer = document.querySelector('#chat-message-input');
            const message = msgInputer.value;
            
            if (message) {
                printLoading();
                // printPopup(message);
                // msgInputer.value = '';

                chatSocket.send(JSON.stringify({
                    'type': 'text',
                    'message': message
                }));

                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆé€ä¿¡å¾Œï¼‰
                addTextMessage('ã‚ãªãŸ', message, 'self');
                
                msgInputer.value = '';
            }
        };
        // document.querySelector('#chat-message-submit').onclick = function(e) {
        //     const msgInputer = document.querySelector('#chat-message-input');
        //     const message = msgInputer.value;
        //     const data = JSON.parse(e.data);
        //     const userMind = data.user_mind || false;
            
        //     if (message && userMind) {
        //         printPopup(message);  // ã“ã“ã§ç¢ºèªã‚’è¡Œã†
        //         msgInputer.value = '';  // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        //     }
        // };

        // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€é€ä¿¡ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-image-submit').onclick = function(e) {
            const imgInputer = document.querySelector('#chat-image-input');
            const fl = imgInputer.files[0];  // é¸æŠã•ã‚ŒãŸæœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

            if (fl) {
                printLoading();

                const read = new FileReader();
                read.onload = function(event) {
                    const imgData = event.target.result;
                    chatSocket.send(JSON.stringify({
                        'type': 'image',  
                        'image_data': imgData
                    }));
                };
                read.readAsDataURL(fl);
            }
        };

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
        function addTextMessage(sender, message, senderType = 'other') {
            const chatLogs = document.getElementById('chat-log');
            const messageContainer = document.createElement('div');
            const msgDiv = document.createElement('div');
            const senderSpan = document.createElement('span');

            // é€ä¿¡è€…åã‚’è¡¨ç¤º
            senderSpan.textContent = `${sender}: `;
            senderSpan.classList.add('sender');

            msgDiv.classList.add('message-received', senderType);
            msgDiv.textContent = message;
            
            messageContainer.classList.add('message-container');
            messageContainer.appendChild(senderSpan);  // é€ä¿¡è€…åã‚’è¿½åŠ 
            messageContainer.appendChild(msgDiv);
            
            chatLogs.appendChild(messageContainer);
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }

        // ç”»åƒã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
        function addImageMessage(sender, imgUrl, senderType = 'other') {
            const chatLogs = document.getElementById('chat-log');
            const messageContainer = document.createElement('div');
            const msgDiv = document.createElement('div');
            const imgEle = document.createElement('img');
            const senderSpan = document.createElement('span');

            // é€ä¿¡è€…åã‚’è¡¨ç¤º
            senderSpan.textContent = `${sender}: `;
            senderSpan.classList.add('sender');

            msgDiv.classList.add('message-received', 'image-message', senderType);
            imgEle.src = imgUrl;

            msgDiv.appendChild(imgEle);
            messageContainer.classList.add('message-container');
            messageContainer.appendChild(senderSpan);  // é€ä¿¡è€…åã‚’è¿½åŠ 
            messageContainer.appendChild(msgDiv);
            
            chatLogs.appendChild(messageContainer);
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }

        function printPopup(message) {
            if (count < 2) {
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã€ã€ŒOKã€ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã«ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                const confirmed = confirm("æ‚ªè³ªãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚æœ¬å½“ã«ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ");
                if (confirmed) {
                    count++;
                    if (count === 2) {
                        // 2å›OKãŒæŠ¼ã•ã‚ŒãŸå ´åˆã«ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                        printLoading();  // NowLoadingã‚’è¡¨ç¤º
                        chatSocket.send(JSON.stringify({
                            'type': 'text',
                            'message': message
                        }));
                        count = 0;  // ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    }
                } else {
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚");
                    notLoading();  // NowLoadingã‚’éè¡¨ç¤º
                    count = 0;
                }
            }
        }

    </script>
</body>
</html>
