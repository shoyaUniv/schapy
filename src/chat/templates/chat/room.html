<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルーム</title>

    <style>
        /* 簡易的なスタイル */
        .message-bubble {
            padding: 5px;
            margin: 5px;
            border-radius: 10px;
        }
        .text-message {
            background-color: #f2f2f2;
            display: inline-block;
        }
        .image-message img {
            max-width: 200px;  /* 画像の表示サイズを調整 */
            border-radius: 10px;
            display: inline-block;
        }

          html {
            font-size: 100%;
            margin: 0;
            padding: 0;
          }
    
          body {
            font-family: "游ゴシック体", YuGothic, "游ゴシック", "Yu Gothic", sans-serif;
            min-height: 100vh;
            line-height: 1.5; /* 行間を1.5倍に設定 */
            margin: 0;
            text-align: center;
          }
    
          header {
            border-bottom: 3px solid #00CCFF;
            padding: 0px 0; /* 上下の余白を追加 */
            text-align: center; /* テキストを中央揃え */
            color: #00CCFF;
          }
    
          header a {
            text-decoration: none;
            color: inherit;
            display: block; /* aタグをブロック要素にすることで、全体をクリック可能に */
            padding: 2px 0; /* 上下に20pxの余白を追加 */
          }
    
          header a h1 {
            font-size: 36px;
            font-weight: bold;
            margin: 0; /* 余計なマージンを削除 */
          }
    
          header a p {
            font-size: 9px;
            margin: 0; /* 余計なマージンを削除 */
          }
    
          img, picture {
            max-width: 100%;
            display: block;
          }
    
          ul[role='list'], ol[role='list'] {
            list-style: none;
          }
    
          input, button, textarea, select {
            font: inherit;
          }

          .typing-animation {
            width: 100ch;
            border-right: 5px solid #000000;
            overflow: hidden;
            white-space: nowrap;
            color:#000000;
            font-size:1.5rem;
            line-height:1.4;
            font-weight:7;
            animation: typing 3s steps(23), blink .4s step-end infinite alternate;
          }
          @keyframes typing {
            from {
              width: 0;
            }
          }
          @keyframes blink {
            50% {
              border-color: transparent;
            }
          }

    </style>

</head>

<header>
    <a href="{% url 'root' %}">
      <h1>Schapy</h1>
    </a>  
</header>

<body>
    <div id="chat-log"></div><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="送信"><br>

    <!-- 画像アップロード用のフォーム -->
    <input id="chat-image-input" type="file" accept="image/*"><br>
    <input id="chat-image-submit" type="button" value="画像アップロード">

    {{ room_name|json_script:"room-name" }}
    
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
    
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/app01/chat/'
            + roomName
            + '/'
        );
    
        //メッセージを受け取る処理
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
    
            if (data.message.includes('が画像を送信しました: ')) {
                // 画像が送信された場合
                // URL or 絵文字を受け取る
                const obj = data.message.split('が画像を送信しました: ')[1]; 
                if (obj.includes('😊')) {
                    // 絵文字が送信された場合
                    addTextMessage(obj);
                } else {
                    // 画像URLが送信された場合
                    addImageMessage(obj);
                }
            } else {
                // テキストメッセージが送信された場合の処理
                addTextMessage(data.message);
            }
        };
    
        // WebSocket切断時、エラーをコンソールに出力
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // 入力ボックスに自動的にフォーカスを設定
        document.querySelector('#chat-message-input').focus();

        // Enterキーが押された場合、送信ボタンをクリックする処理
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            // Enterキー（キーコード13）が押されたとき
            if (e.keyCode === 13) { 
                // 送信ボタンをクリック
                document.querySelector('#chat-message-submit').click(); 
            }
        };

        // テキストメッセージを送信する処理
        document.querySelector('#chat-message-submit').onclick = function(e) {
            // メッセージ入力フィールド取得
            const msgInputer = document.querySelector('#chat-message-input');
            // 入力メッセージ取得
            const message = msgInputer.value;
            // WebSocketを用いて、サーバーにメッセージ送信
            chatSocket.send(JSON.stringify({
                // メッセージタイプは'text'
                'type': 'text',
                // メッセージ内容
                'message': message
            }));
            // メッセージ入力フィールドを白紙にする
            msgInputer.value = '';
        };

        // 画像をアップロードし、送信する処理
        document.querySelector('#chat-image-submit').onclick = function(e) {
            // 画像ファイル入力フィールドを取得
            const imgInputer = document.querySelector('#chat-image-input');
            const fl = imgInputer.files[0];  // 選択された最初のファイルを取得

            // ファイルが選択された場合
            if (fl) {
                // FileReaderを使用し、ファイル読み込み
                const read = new FileReader();
                read.onload = function(event) {
                    // 画像データ(Base64)を取得
                    const imgData = event.target.result;
                    // WebSocketを用いて、サーバーに画像データ送信
                    chatSocket.send(JSON.stringify({
                        // メッセージタイプは'image'
                        'type': 'image',  
                         // 画像データ
                        'image_data': imgData
                    }));
                };
                // 画像データをBase64に変換
                read.readAsDataURL(fl);
            }
        };

        // テキストをチャットに追加
        function addTextMessage(message) {
            // チャットログの要素取得
            const chatLogs = document.getElementById('chat-log');
            // 新しいメッセージのdivを作成
            const msgDiv = document.createElement('div');
            // テキストのスタイル追加
            msgDiv.classList.add('message-bubble', 'text-message');
            // 内容の設定
            msgDiv.textContent = message;
            // チャットログへメッセージ追加
            chatLogs.appendChild(msgDiv);
            // チャットログを自動スクロール
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }

        // 画像をチャットログに追加
        function addImageMessage(imgUrl) {
            // チャットログの要素取得
            const chatLogs = document.getElementById('chat-log');
            // 新しいメッセージのdivを作成
            const msgDiv = document.createElement('div');
            // 画像ののスタイル追加
            msgDiv.classList.add('message-bubble', 'image-message');
            // img要素作成
            const imgEle = document.createElement('img');
            // 画像URL設定
            imgEle.src = imgUrl;
            // 画像サイズの最大幅調整
            imgEle.style.maxWidth = '20%'
            // 画像をメッセージに追加;
            msgDiv.appendChild(imgEle);
            // チャットログにメッセージを追加
            chatLogs.appendChild(msgDiv);
            // チャットログを自動スクロール
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }
    </script>        
</body>
</html>
