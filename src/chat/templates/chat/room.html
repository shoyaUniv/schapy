<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <style>
        /* ç°¡æ˜“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
        .message-bubble {
            padding: 5px;
            margin: 5px;
            border-radius: 10px;
        }
        .text-message {
            background-color: #f2f2f2;
            display: inline-block;
        }
        .image-message img {
            max-width: 200px;  /* ç”»åƒã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            border-radius: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="chat-log"></div><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send"><br>

    <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ  -->
    <input id="chat-image-input" type="file" accept="image/*"><br>
    <input id="chat-image-submit" type="button" value="Upload Image">

    {{ room_name|json_script:"room-name" }}
    
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
    
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/app01/chat/'
            + roomName
            + '/'
        );
    
        //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹å‡¦ç†
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
    
            if (data.message.includes('ãŒç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ: ')) {
                // ç”»åƒãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                // URL or çµµæ–‡å­—ã‚’å—ã‘å–ã‚‹
                const obj = data.message.split('ãŒç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ: ')[1]; 
                if (obj.includes('ğŸ˜Š')) {
                    // çµµæ–‡å­—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                    addTextMessage(obj);
                } else {
                    // ç”»åƒURLãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
                    addImageMessage(obj);
                }
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
                addTextMessage(data.message);
            }
        };
    
        // WebSocketåˆ‡æ–­æ™‚ã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã«è‡ªå‹•çš„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
        document.querySelector('#chat-message-input').focus();

        // Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            // Enterã‚­ãƒ¼ï¼ˆã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰13ï¼‰ãŒæŠ¼ã•ã‚ŒãŸã¨ã
            if (e.keyCode === 13) { 
                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                document.querySelector('#chat-message-submit').click(); 
            }
        };

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-message-submit').onclick = function(e) {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—
            const msgInputer = document.querySelector('#chat-message-input');
            // å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
            const message = msgInputer.value;
            // WebSocketã‚’ç”¨ã„ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            chatSocket.send(JSON.stringify({
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã¯'text'
                'type': 'text',
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
                'message': message
            }));
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç™½ç´™ã«ã™ã‚‹
            msgInputer.value = '';
        };

        // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€é€ä¿¡ã™ã‚‹å‡¦ç†
        document.querySelector('#chat-image-submit').onclick = function(e) {
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
            const imgInputer = document.querySelector('#chat-image-input');
            const fl = imgInputer.files[0];  // é¸æŠã•ã‚ŒãŸæœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            if (fl) {
                // FileReaderã‚’ä½¿ç”¨ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                const read = new FileReader();
                read.onload = function(event) {
                    // ç”»åƒãƒ‡ãƒ¼ã‚¿(Base64)ã‚’å–å¾—
                    const imgData = event.target.result;
                    // WebSocketã‚’ç”¨ã„ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒãƒ‡ãƒ¼ã‚¿é€ä¿¡
                    chatSocket.send(JSON.stringify({
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã¯'image'
                        'type': 'image',  
                         // ç”»åƒãƒ‡ãƒ¼ã‚¿
                        'image_data': imgData
                    }));
                };
                // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Base64ã«å¤‰æ›
                read.readAsDataURL(fl);
            }
        };

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
        function addTextMessage(message) {
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®è¦ç´ å–å¾—
            const chatLogs = document.getElementById('chat-log');
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®divã‚’ä½œæˆ
            const msgDiv = document.createElement('div');
            // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            msgDiv.classList.add('message-bubble', 'text-message');
            // å†…å®¹ã®è¨­å®š
            msgDiv.textContent = message;
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
            chatLogs.appendChild(msgDiv);
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }

        // ç”»åƒã‚’ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«è¿½åŠ 
        function addImageMessage(imgUrl) {
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®è¦ç´ å–å¾—
            const chatLogs = document.getElementById('chat-log');
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®divã‚’ä½œæˆ
            const msgDiv = document.createElement('div');
            // ç”»åƒã®ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            msgDiv.classList.add('message-bubble', 'image-message');
            // imgè¦ç´ ä½œæˆ
            const imgEle = document.createElement('img');
            // ç”»åƒURLè¨­å®š
            imgEle.src = imgUrl;
            // ç”»åƒã‚µã‚¤ã‚ºã®æœ€å¤§å¹…èª¿æ•´
            imgEle.style.maxWidth = '20%'
            // ç”»åƒã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ ;
            msgDiv.appendChild(imgEle);
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            chatLogs.appendChild(msgDiv);
            // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            chatLogs.scrollTop = chatLogs.scrollHeight;
        }
    </script>        
</body>
</html>
